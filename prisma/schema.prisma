// Prisma schema for multi-tenant support portal
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER (Account Owner - Main Domain)
// ==========================================

model User {
  id              String    @id @default(cuid())
  discordId       String    @unique          // Discord user ID (snowflake)
  discordUsername String                     // For display
  discordAvatar   String?                    // Avatar URL

  email           String?                    // Optional email for billing notifications

  // Stripe
  stripeCustomerId String?  @unique          // Stripe customer ID

  // Relations
  subscription    Subscription?
  tenants         Tenant[]                   // User can own multiple tenants (future-proof)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([discordId])
  @@index([stripeCustomerId])
}

// ==========================================
// SUBSCRIPTION (Stripe Billing)
// ==========================================

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stripe IDs
  stripeSubscriptionId String             @unique
  stripePriceId        String                      // The price they subscribed to

  // Status
  status               SubscriptionStatus @default(ACTIVE)

  // Billing period
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?

  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@index([stripeSubscriptionId])
  @@index([status])
}

enum SubscriptionStatus {
  ACTIVE      // Paid and current
  PAST_DUE    // Payment failed, in grace period
  CANCELED    // Canceled but still active until period end
  EXPIRED     // Subscription ended, no access
}

// ==========================================
// TENANT (Core)
// ==========================================

model Tenant {
  id        String   @id @default(cuid())
  slug      String   @unique // subdomain: "acme" -> acme.helpportal.app
  name      String // Display name: "Acme Corp Support"
  status    TenantStatus @default(PENDING)
  plan      TenantPlan   @default(FREE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Owner (User who created/pays for this tenant)
  ownerId   String?
  owner     User?    @relation(fields: [ownerId], references: [id])

  // Ticketing provider preference
  ticketProvider TicketProviderType?

  // Relations
  hygraphConfig    TenantHygraphConfig?
  jiraConfig       TenantJiraConfig?
  discordBotConfig TenantDiscordBotConfig?
  branding         TenantBranding?
  features         TenantFeatures?
  webhookConfig    TenantWebhookConfig?
  users            TenantUser[]

  @@index([slug])
  @@index([status])
  @@index([ownerId])
}

enum TenantStatus {
  PENDING    // Just signed up, awaiting verification
  SETUP      // Verified, completing onboarding
  ACTIVE     // Fully operational
  SUSPENDED  // Temporarily disabled
  CANCELLED  // Account closed
}

enum TenantPlan {
  FREE
  PRO
  ENTERPRISE
}

enum TicketProviderType {
  JIRA
}

// ==========================================
// HYGRAPH CMS CONFIG (Per Tenant)
// ==========================================

model TenantHygraphConfig {
  tenantId  String   @id
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  endpoint  String   // Hygraph API endpoint
  token     String   // Encrypted API token

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// JIRA OAUTH CONFIG (Per Tenant)
// ==========================================

model TenantJiraConfig {
  tenantId  String   @id
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Connection state
  connected       Boolean  @default(false)
  authMode        String   @default("api_token")  // "oauth" or "api_token"

  // Atlassian Cloud identifiers
  cloudId         String?  // Jira site identifier for API calls
  cloudUrl        String?  // e.g., "https://acme.atlassian.net"

  // Tokens (encrypted) — interpretation depends on authMode:
  //   oauth:     accessToken = OAuth access token, refreshToken = OAuth refresh token
  //   api_token: accessToken = API token, refreshToken = email
  accessToken     String?
  refreshToken    String?
  tokenExpiry     DateTime?

  // Project selection
  projectKey      String?
  projectId       String?  // Jira project ID (needed for Automation ARI)
  serviceDeskId   String?
  requestTypeId   String?

  // Automation rule setup
  automationRuleCreated Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// DISCORD BOT CONFIG (Per Tenant)
// ==========================================

model TenantDiscordBotConfig {
  tenantId  String   @id
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  botToken  String   // Encrypted — tenant-provided bot token
  guildId   String   // Discord server ID (snowflake)
  enabled   Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// DISCORD BOT SETUP (Channel & Preferences)
// ==========================================

model DiscordBotSetup {
  id                   String   @id  // botIdentifier: tenantId or '__main__'
  guildId              String
  ticketChannelId      String?
  logChannelId         String?
  supportCategoryId    String?  // Discord category ID for Support channels
  ticketPanelMessageId String?
  dmOnCreate           Boolean  @default(true)
  dmOnUpdate           Boolean  @default(true)
  panelTitle           String   @default("Support Tickets")
  panelDescription     String   @default("Select a category and severity, then click **Create Ticket**.")
  panelButtonLabel     String   @default("Create Ticket")
  panelInfoLines       String?  // JSON array of strings

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

// ==========================================
// STAFF MAPPING (Discord ↔ Jira Account)
// ==========================================

model StaffMapping {
  id            String   @id @default(cuid())
  botId         String   // Bot identifier (tenantId or '__main__')
  discordUserId String
  jiraAccountId String?  // Optional - staff can work without Jira account
  displayName   String?  // Friendly label, e.g. "John (Mod)"

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([botId, discordUserId])
  @@index([botId])
}

// ==========================================
// TICKET DM TRACKER (Editable DM Messages)
// ==========================================

model TicketDMTracker {
  id            String   @id @default(cuid())
  tenantId      String   // botIdentifier
  ticketId      String   // Jira issue key e.g. "SUPPORT-142"
  discordUserId String
  dmMessageId   String
  dmChannelId   String

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([tenantId, ticketId, discordUserId])
  @@index([discordUserId])
}

// Tracks the log channel message for each ticket (for editing on status/assignment changes)
model TicketLogMessage {
  id            String   @id @default(cuid())
  tenantId      String   // botIdentifier
  ticketId      String   // Jira issue key e.g. "SUPPORT-142"
  channelId     String   // Log channel ID
  messageId     String   // Discord message ID
  discordUserId String   // Ticket creator's Discord ID (for rebuilding the panel)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([tenantId, ticketId])
  @@index([ticketId])
}

// Tracks private ticket channels created when staff assigns a ticket
model TicketChannel {
  id            String   @id @default(cuid())
  tenantId      String   // botIdentifier
  ticketId      String   // Jira issue key e.g. "SUPPORT-142"
  channelId     String   // Discord channel ID
  assignedModId String   // Discord user ID of assigned mod
  discordUserId String   // Ticket creator's Discord ID

  createdAt     DateTime @default(now())

  @@unique([tenantId, ticketId])
  @@index([ticketId])
  @@index([channelId])
}

// ==========================================
// BRANDING (Per Tenant)
// ==========================================

model TenantBranding {
  tenantId  String   @id
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  logoUrl       String?  // Custom logo
  faviconUrl    String?  // Custom favicon
  primaryColor  String?  // Hex color override (legacy, prefer theme)
  theme         String?  // Theme ID: "discord", "dark", "light"
  customDomain  String?  // e.g., "support.acmecorp.com"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// FEATURE FLAGS (Per Tenant)
// ==========================================

model TenantFeatures {
  tenantId  String   @id
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  articlesEnabled      Boolean @default(true)
  servicesEnabled      Boolean @default(true)
  ticketsEnabled       Boolean @default(true)
  discordLoginEnabled  Boolean @default(true)
  tipsEnabled          Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// WEBHOOK CONFIG (For Hygraph Cache Invalidation)
// ==========================================

model TenantWebhookConfig {
  tenantId  String   @id
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  webhookSecret       String   // Secret for validating incoming webhooks
  webhookEnabled      Boolean  @default(true)
  lastWebhookAt       DateTime?
  webhookFailureCount Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// TENANT USER (Users who sign up on any domain)
// ==========================================

model TenantUser {
  id              String   @id @default(cuid())
  tenantId        String?  // null = main domain user
  tenant          Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Discord OAuth identity
  discordId       String
  discordUsername String
  discordAvatar   String?
  email           String?

  // Stripe customer ID (main domain only)
  stripeCustomerId String?

  // Status
  status          TenantUserStatus @default(ACTIVE)

  // Discord bot DM opt-in
  discordNotifications Boolean @default(false)

  // Relations
  subscription    TenantSubscription?

  // Custom data from CMS-driven onboarding
  onboardingData  Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tenantId, discordId])
  @@index([tenantId])
  @@index([discordId])
}

enum TenantUserStatus {
  ACTIVE
  SUSPENDED
}

// ==========================================
// TENANT SUBSCRIPTION (User subscriptions to products)
// ==========================================

model TenantSubscription {
  id                   String   @id @default(cuid())
  tenantUserId         String   @unique
  tenantUser           TenantUser @relation(fields: [tenantUserId], references: [id], onDelete: Cascade)

  // Product reference (slug from CMS)
  productSlug          String

  // Stripe IDs
  stripeSubscriptionId String   @unique
  stripePriceId        String

  // Status (reuse existing enum)
  status               SubscriptionStatus @default(ACTIVE)

  // Billing period
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean  @default(false)
  canceledAt           DateTime?

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([stripeSubscriptionId])
  @@index([productSlug])
}

